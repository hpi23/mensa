beantrage Geld von Hasso;
beantrage Drucke von Drucker;
beantrage Http von Netzwerk;
beantrage Gliedere_JSON von Textverarbeitung;
beantrage Zergliedere_JSON von Textverarbeitung;
beantrage Formatiere von Textverarbeitung;
beantrage Aufgeben von libSAP;
beantrage Umgebungsvariablen von libSAP;
beantrage Argumente von libSAP;
beantrage Zeit von Uhr;
beantrage Versions_Nummer von libSAP;

//
// ANFANG LIB.
//

//
// Datentypen.
//

datentyp Speise auf Objekt {
    Zeichenkette Titel /
    Zeichenkette Beschreibung /
    Flie√ükommazahl Preis /

    // LECKER NAEHRWERTE.
    Flie√ükommazahl Protein_GR /
    Flie√ükommazahl Kcal /
    Flie√ükommazahl Fett_GR /
    Flie√ükommazahl Zucker_GR /
    Flie√ükommazahl Kohlenhydrate_GR /

    Zeichenkette ZeitSlot /
    Zahl VeganFlaggen /
};

//
// Konstanten.
//

setze Zahl MENSA_FILMUNI auf 9603;
setze Zahl MENSA_GRIEBNITZSEE auf 9601;
setze Zeichenkette MENSA_URL_GENERISCH auf "https://stwwb.webspeiseplan.de/index.php?token=55ed21609e26bbf68ba2b19390bf7961&model=menu&location=%d&languagetype=2&_=%d";

//
// Funktionen.
//

funk Lade_Speiseangebot(Zahl Mensa_Ort / Zahl Tages_Verschiebung) ergibt Liste von Speise {
    setze Zeichenkette K√∂rper auf "";
    setze Zahl Aktuelle_Zeit auf Zeit().Unix;
    setze Zeichenkette URL auf Formatiere(MENSA_URL_GENERISCH / Mensa_Ort / Aktuelle_Zeit);
    Drucke(URL);
    setze Zahl Antwort_Zahl auf Http(
        "GET" /
        URL /
        "" /
        [
            erstelle {
                Zeichenkette Schl√ºssel auf "Referer" /
                Zeichenkette Wert auf "https://stwwb.webspeiseplan.de/menu" /
            }
        ] /
        &K√∂rper /
    );

    falls Antwort_Zahl != 200 {
        Aufgeben(1);
    }

    Drucke("Heruntergeladen, Zergliedere_JSON()...");

    setze Speicherbox Res auf Zergliedere_JSON(K√∂rper) als Speicherbox;
    setze Liste von Speicherbox ContentRes auf Res.Nehmen("content") als Liste von Speicherbox;
    setze Zahl Z√§hler auf 0;

    setze Liste von Speise Resultat auf [];

    solange Z√§hler < ContentRes.L√§nge() {
        setze Speicherbox ResTemp auf ContentRes[Z√§hler];
        setze Liste von Speicherbox Gerichte auf ResTemp.Nehmen("speiseplanGerichtData") als Liste von Speicherbox;
        setze Speicherbox SpeiseplanAdvanced auf ResTemp.Nehmen("speiseplanAdvanced") als Speicherbox;
        setze Zeichenkette ZeitSlot auf SpeiseplanAdvanced.Nehmen("titel") als Zeichenkette;

        setze Zahl Gerichtz√§hler auf 0;
        solange (Gerichtz√§hler < Gerichte.L√§nge()) {
            setze Speicherbox Gericht auf Gerichte[Gerichtz√§hler];
            Gerichtz√§hler += 1;

            setze Speicherbox ZusatzInfos auf Gericht.Nehmen("zusatzinformationen") als Speicherbox;

            // DIES STIRBT MANCHMAL.
            setze Flie√ükommazahl Preis auf ZusatzInfos.Nehmen("mitarbeiterpreisDecimal2") als Flie√ükommazahl;

            setze Flie√ükommazahl Protein auf ZusatzInfos.Nehmen("nweiweissDecimal1") als Flie√ükommazahl;
            setze Flie√ükommazahl Kcal auf ZusatzInfos.Nehmen("nwkcalInteger") als Flie√ükommazahl;
            setze Flie√ükommazahl Fett auf ZusatzInfos.Nehmen("nwfettDecimal1") als Flie√ükommazahl;
            setze Flie√ükommazahl Zucker auf ZusatzInfos.Nehmen("nwzuckerDecimal1") als Flie√ükommazahl;
            setze Flie√ükommazahl Kohlenhydrate auf ZusatzInfos.Nehmen("nwzuckerDecimal1") als Flie√ükommazahl;

            setze Zahl VeganFlaggen auf -1;
            setze Zeichenkette MerkmaleTyp auf Gericht.NehmeTyp("gerichtmerkmaleIds");

            falls MerkmaleTyp != "Nichts" {
                setze Zeichenkette GerichtmerkmaleIds auf Gericht.Nehmen("gerichtmerkmaleIds") als Zeichenkette;

                aendere VeganFlaggen auf 0;
                falls GerichtmerkmaleIds.Enth√§lt("228") {
                    aendere VeganFlaggen auf 2;
                } sonst falls GerichtmerkmaleIds.Enth√§lt("229") {
                    aendere VeganFlaggen auf 1;
                }
            }


            setze Speicherbox GerichtInfos auf Gericht.Nehmen("speiseplanAdvancedGericht") als Speicherbox;
            setze Zeichenkette GerichtDatumRoh auf GerichtInfos.Nehmen("datum") als Zeichenkette;

            setze Zeichenkette GerichtDatum auf GerichtDatumRoh.Zertrenne("T")[0];

            setze Zahl Verwendeter_Tag auf Zeit().Kalendar_Tag + Tages_Verschiebung; // OHH neinnn, das kaputtchen
            setze Zahl Verwendeter_Monat auf Zeit().Monat; // OHH neinnn, das kaputtchen

            // KB bei nicht 31 tage oder bei Dezember
            falls Verwendeter_Tag == 32 {
                aendere Verwendeter_Tag auf 1;
                aendere Verwendeter_Monat auf Verwendeter_Monat + 1;
            }

            setze Zeichenkette HeuteDatum auf Formatiere("%d-%2d-%2d" / Zeit().Jahr / Verwendeter_Monat / Verwendeter_Tag);
            setze Zeichenkette Gerichtname auf GerichtInfos.Nehmen("gerichtname") als Zeichenkette;

            setze Zahl Kaunter auf -1;

            falls Gerichtname.Enth√§lt("COUNTER 1") {
                aendere Kaunter auf 1;
            } sonst falls Gerichtname.Enth√§lt("COUNTER 2") {
                aendere Kaunter auf 2;
            } sonst falls Gerichtname.Enth√§lt("COUNTER 3") {
                aendere Kaunter auf 3;
            } sonst falls Gerichtname.Enth√§lt("COUNTER 4") {
                aendere Kaunter auf 4;
            }

             aendere Gerichtname auf Gerichtname
                .Ersetze("\n" / "")
                .Ersetze("COUNTER 1 / " / "")
                .Ersetze("COUNTER 2 / " / "")
                .Ersetze("COUNTER 3 / " / "")
                .Ersetze("COUNTER 4 / " / "");

            falls
                (GerichtDatum != HeuteDatum)
                || Gerichtname.Startet_Mit("Salatbuffet")
                || Gerichtname.Enth√§lt("Relevo")
                || Gerichtname.Enth√§lt("kleine Schale") // WARUMMM!!!
                || Gerichtname.Enth√§lt("Wochenende!")
                || Gerichtname.Enth√§lt("Preise pro 100 g")
                || Gerichtname.Enth√§lt("Preis pro 100 g")
                || Gerichtname.Enth√§lt("Preis pro 100g") { // WARUM??? Es gibt einfach beide!
                weitermachen;
            }

            setze Zeichenkette Titel auf Formatiere("Kaunter %d" / Kaunter);
            falls Kaunter == -1 {
                aendere Titel auf "K/A      ";
            }

            Resultat.Hinzuf√ºgen(erstelle {
                Zeichenkette ZeitSlot auf ZeitSlot /
                Zeichenkette Titel auf Titel /
                Zeichenkette Beschreibung auf Gerichtname /
                Flie√ükommazahl Preis auf Preis /
                Fliesskommazahl Protein_GR auf Protein /
                Fliesskommazahl Kcal auf Kcal /
                Fliesskommazahl Fett_GR auf Fett /
                Fliesskommazahl Zucker_GR auf Zucker /
                Fliesskommazahl Kohlenhydrate_GR auf Kohlenhydrate /
                Zeichenkette ZeitSlot auf ZeitSlot /
                Zahl VeganFlaggen auf VeganFlaggen /
            });

        }

        Z√§hler += 1;
    }

    Resultat
}

//
// ENDE LIB.
//

setze Zeichenkette KEINE_DATEN auf "! OBACHT: Keine Daten vorhanden";
setze Wahrheitswert ZEIGE_MEHR_NACHRICHTEN auf nein;


funk Bewerbung() ergibt Zeichenkette { "Hallo Welt!" }

funk Einschreibung(Zahl Matrikelnummer) ergibt Nichts {
  setze Zahl _ auf Matrikelnummer;
}

funk Studium() ergibt Nichts {
    setze Liste von Zeichenkette A auf Argumente();
    Drucke(Haupt(A));
}

funk Haupt(Liste von Zeichenkette Args) ergibt Zeichenkette {
    Drucke(Args);

    setze Liste von Zeichenkette Ausgabe auf [];

    falls Args.L√§nge() == 1 {
        Drucke("Erwartete Befehlszeilenargument <mensa-ort> <tages-verschiebung (wenn du willst)>, bekam nichts");
        Aufgeben(69);
    }

    falls Args.L√§nge() > 3 {
        Drucke("Erwartete Befehlszeilenargument <mensa-ort> <tages-verschiebung (wenn du willst)>, bekam vieel zu vieel");
        Aufgeben(69);
    }

    setze Zeichenkette Eingabe auf Args[1];
    setze Zahl Tages_Verschiebung auf 0;

    // EXTREMST ABGEFUCKT -> das sollte aber nicht kaputt gehen???
    // SORRY, falls das jemand findet -- Mike Myueller
    falls Args.L√§nge() == 3 {
        setze Zeichenkette Parser_Eingabe auf Formatiere("{\"tage\": %s}" / Args[2]);
        setze Speicherbox Parser_Ausgabe auf Zergliedere_JSON(Parser_Eingabe) als Speicherbox;
        aendere Tages_Verschiebung auf Parser_Ausgabe.Nehmen("tage") als Zahl;
        //Drucke(Tages_Verschiebung); // THIS FUCKS ITSELF IF THERE IS NO ;
    }

    setze Zahl Mensa_Ort auf 0;

    falls Eingabe == "hpi" {
        √§ndere Mensa_Ort auf MENSA_GRIEBNITZSEE;
    } sonst falls Eingabe == "filmuni" {
        √§ndere Mensa_Ort auf MENSA_FILMUNI;
    } sonst falls Eingabe == "bernau" {
        Drucke(Formatiere("Gef√§hrlicher Standort: <%s>\nValide, weniger gef√§hrliche Standorte:\n    - hpi\n    - filmuni" / Eingabe));
        Drucke("UND: wurde in Bernau √ºberhaupt schon Essen erfunden? - Oder gibt es da nur Salz?");
        Aufgeben(69);
    } sonst {
        Drucke(Formatiere("Unbekannter Standort: <%s>\nValide Standorte:\n    - hpi\n    - filmuni" / Eingabe));
        Aufgeben(42);
    }

    // Erwarte einen Wahrheitswert fuer logging.
    falls Args.L√§nge() == 3 {
        √§ndere Eingabe auf Args[2];
        falls Eingabe == "schreibe" {
            √§ndere ZEIGE_MEHR_NACHRICHTEN auf ja;
        }
    }

    Ausgabe.Hinzuf√ºgen(Formatiere("FAHRE HPI script version V%s f√ºr LINUX oder MACAROON" / Versions_Nummer()));
    Ausgabe.Hinzuf√ºgen("========================================================");

    Ausgabe.Hinzuf√ºgen(Aktualisiere(Mensa_Ort / Tages_Verschiebung));
    ueberweise Verflache_Ausgabe(Ausgabe);
}

funk Aktualisiere(Zahl Mensa_Ort / Zahl Tages_Verschiebung) ergibt Zeichenkette {
    setze Liste von Zeichenkette Ausgabe auf [];

    Ausgabe.Hinzuf√ºgen("    ~> Lade Speiseangebot aus dem Internet herunter...");
    falls Tages_Verschiebung != 0 {
        Ausgabe.Hinzuf√ºgen(Formatiere("    ~> ANMERKUNG: Speiseangebot wird um %d Tag(e) verschoben." / Tages_Verschiebung));
    }
    setze Liste von Speise Speisen auf Lade_Speiseangebot(Mensa_Ort / Tages_Verschiebung);
    Ausgabe.Hinzuf√ºgen(Formatiere("    ~> Speiseangebot bereit. %d Speisen geladen." / Speisen.L√§nge()));


    setze Liste von Speise Mittagessen auf [];
    setze Liste von Speise Abendessen auf [];

    setze Zahl Z√§hler auf 0;
    solange Z√§hler < Speisen.L√§nge() {
        setze Speise S auf Speisen[Z√§hler];
        setze Zeichenkette ZeitSlot auf S.ZeitSlot.Ersetze(" " / "");
        falls ZeitSlot.Enth√§lt("Mittagessen") {
            Mittagessen.Hinzuf√ºgen(S);
        } sonst falls ZeitSlot.Enth√§lt("Abendessen") {
            Abendessen.Hinzuf√ºgen(S);
        } sonst falls ZeitSlot.Enth√§lt("Automatenplan") {
            falls ZEIGE_MEHR_NACHRICHTEN {
                Ausgabe.Hinzuf√ºgen("[NACHRICHT] Ignoriere Automat");
            }
        } sonst {
            Drucke(Formatiere("Nicht unterst√ºtzter ZeitSlot: `%s`" / ZeitSlot));
            Aufgeben(1);
        }
        Z√§hler += 1;
    }


    Ausgabe.Hinzuf√ºgen("======= MITTAGESSEN ========");

     Ausgabe.Hinzuf√ºgen(Gericht_Liste_Drucken(Mittagessen));

    Ausgabe.Hinzuf√ºgen("======== ABENDESSEN ========");

    Ausgabe.Hinzuf√ºgen(Gericht_Liste_Drucken(Abendessen));

    ueberweise Verflache_Ausgabe(Ausgabe);
}

funk Gericht_Liste_Drucken(Liste von Speise Eingabe) ergibt Zeichenkette {
    setze Liste von Zeichenkette Ausgabe auf [];

    setze Fliesskommazahl Maximale_Protein auf 0,0;

    setze Zahl Z√§hler auf 0;
    solange Z√§hler < Eingabe.L√§nge() {
        setze Speise S auf Eingabe[Z√§hler];
        falls S.Protein_GR > Maximale_Protein {
            aendere Maximale_Protein auf S.Protein_GR;
        }

        Z√§hler += 1;
    }

    setze Zahl Z√§hler auf 0;
    solange Z√§hler < Eingabe.L√§nge() {
        setze Speise S auf Eingabe[Z√§hler];

        setze Zeichenkette VeganEmojii auf "?";

        falls S.VeganFlaggen == 0 {
            aendere VeganEmojii auf "üö´";
        } sonst falls S.VeganFlaggen == 1 {
            aendere VeganEmojii auf "üêÑ";
        } sonst falls S.VeganFlaggen == 2 {
            aendere VeganEmojii auf "üå±";
        }

        Ausgabe.Hinzuf√ºgen(Formatiere("\x1b[0;32m    - %s %s | %.2f‚Ç¨ | %s\x1b[0m" / VeganEmojii / S.Titel / S.Preis / S.Beschreibung));
        Ausgabe.Hinzuf√ºgen(Formatiere(
            "\x1b[0;31m        * %3@ d Kcal        * %3@ dg. Protein        * %3@ dg. Fett          * %3@ dg. Kohl.\x1b[0m"
            / S.Kcal als Zahl
            / S.Protein_GR als Zahl
            / S.Fett_GR als Zahl
            / S.Kohlenhydrate_GR als Zahl
            ));
        Z√§hler += 1;
    }

    falls Z√§hler == 0 {
        // HOLY BALLS: this fails to compile if there is the ; missing
        Ausgabe.Hinzuf√ºgen(Formatiere("    %s" / KEINE_DATEN));
    }

    ueberweise Verflache_Ausgabe(Ausgabe);
}

funk Verflache_Ausgabe(Liste von Zeichenkette Roh) ergibt Zeichenkette {
    setze Zeichenkette Flache_Ausgabe auf "";
    setze Zahl Ausgaben_Zaehler auf 0;

    solange Ausgaben_Zaehler < Roh.L√§nge() {
        setze Zeichenkette Ende auf "\n";
        falls Ausgaben_Zaehler == Roh.L√§nge() {
            aendere Ende auf "";
        }
        aendere Flache_Ausgabe auf Formatiere("%s%s%s" / Flache_Ausgabe / Roh[Ausgaben_Zaehler] / Ende);
        Ausgaben_Zaehler += 1;
    }

    ueberweise Flache_Ausgabe;
}
